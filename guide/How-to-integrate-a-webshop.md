---
tags: [guide, shortlink, qr]
internal: true
---

# How to integrate a webshop

**In this tutorial we will integrate is a generic web shop that uses a custome ecommerce point of sale system,  which allows their staff to accept payments at customers' tables. They accept cash, card and Settle.**

When a client wishes to pay with Settle, the POS generates a QR code for the customer to scan, which is used by the POS vendor to initiate a payment request.

### 1. Generating the QR code

The POS generates and displays a QR code which contains the **shortlink ID** and a **transaction ID** generated by the vendor's backend system.

Settle expects a scanned QR code to contain a specific URL:

```
http://settle.eu/s/<shortlink_id>/<vendors_transaction_id>
```

Note that _<http://settle.eu/s/>\<shortlink_id>/_ is mandatory, the rest of the URL (_vendors_transaction_id_) will be sent to the callback handler.

### 2. QR code scan

When the customer scans the QR code and the scan is registered by Settle, Settle generates a unique _[scan token](https://developer.settle.eu/callbacks.html#callbacks-shortlink)_ which can be used by the vendor's backend system to initiate a payment request.

### 3. Callback

Settle calls the vendor's specified _callback_uri_, passing in the _scan token_ which can be used to create a payment request. The 'extra' information encoded in the QR code (_vendors_transaction_id_ in this example) is also present in the payload.

The following is an example of the payload that would be sent to the vendor's backend when a QR code containing `http://settle.eu/s/<shortlink_id>/<vendors_transaction_id>` is scanned:

```json
{
  "meta": {
    "seqno": 0,
    "labels": [

    ],
    "uri": null,
    "id": "D5S6WYjnQ_ObT-DyZfrVPA",
    "context": "ctx:D5S6WYjnQ_ObT-DyZfrVPA",
    "timestamp": "2019-03-21 08:58:49",
    "event": "shortlink_scanned"
  },
  "object": {
    "id": "token:5632006343884800",
    "argstring": "vendors_transaction_id"
  }
}
```

The _scan token_ for this scan is `token:5632006343884800`.

### 4. Payment request

The vendor initiates a [`payment request`](https://developer.settle.eu/handlers.html#post--payment_request- "POST /payment_request/") using the _[scan token](https://developer.settle.eu/callbacks.html#callbacks-shortlink)_ that Settle generated as the value in the `customer` field.

Example payment request for â‚¬20, using the _scan token_ from the previous section:

```json
// POST https://api.settle.demo/merchant/v1/payment_request/

{
  "action": "SALE",
  "allow_credit": true,
  "pos_tid": "vendors_transaction_id",
  "pos_id": "id-of-the-pos",
  "customer": "token:5632006343884800",
  "currency": "EUR",
  "amount": 2000
}
```

Example response:

```json
{
  "id": "p2ybyw4tq73n",
  "uri": null
}
```

Note that the `id` field in the response is Settle's **transaction id** (`tid`), which is used to identify the payment in future API calls.

After creating the payment request, the vendor should poll the [`payment outcome`](https://developer.settle.eu/handlers.html#get--payment_request--tid--outcome- "GET /payment_request/\<tid>/outcome/") endpoint, and monitor status changes. A newly created payment request will have `status_code` set to _1003 (PENDING)_.

Example outcome with status _1003 (PENDING)_:

```json
{
  "meta": {
    "seqno": 0,
    "labels": [

    ],
    "uri": null,
    "id": "D5S6WYjnQ_ObT-DyZfrVPA",
    "context": "ctx:D5S6WYjnQ_ObT-DyZfrVPA",
    "timestamp": "2019-03-21 08:58:49",
    "event": "shortlink_scanned"
  },
  "object": {
    "id": "token:5632006343884800",
    "argstring": "vendors_transaction_id"
  }
}
```

### 5. Payment confirmation

A message appears on the customer's phone asking them to confirm the payment.

If the user confirms the payment, the `status_code` returned from the [`payment outcome`](https://developer.settle.eu/handlers.html#get--payment_request--tid--outcome- "GET /payment_request/\<tid>/outcome/") endpoint changes to _3008 (AUTH)_:

```json
// POST https://api.settle.demo/merchant/v1/payment_request/

{
  "action": "SALE",
  "allow_credit": true,
  "pos_tid": "vendors_transaction_id",
  "pos_id": "id-of-the-pos",
  "customer": "token:5632006343884800",
  "currency": "EUR",
  "amount": 2000
}
```

Note that `auth_amount` changed from `0` to `2000`.

If the user chooses to reject the payment, `status_code` changes to _5006 (REJECTED)_.

### 6. Waiting for authorization

As soon as the customer confirms the payment in their app, Settle will attempt to authorize the payment. When `status_code` changes to _3008 (AUTH)_, the payment can be captured.

### 7. Capturing the payment

The vendor captures the payment using the [`PUT /payment_request/<tid>/`](https://developer.settle.eu/handlers.html#put--payment_request--tid-- "PUT /payment_request/\<tid>/") endpoint, sending in `{action: "capture"}`:

```json
{
  "id": "p2ybyw4tq73n",
  "uri": null
}
```

Note that the payment must be authorized before capture is possible; it is an error to try to capture a payment that does not have `status_code` _3008 (AUTH)_.

### 8. Verifying the capture

Again, polling the [`payment outcome`](https://developer.settle.eu/handlers.html#get--payment_request--tid--outcome- "GET /payment_request/\<tid>/outcome/"), the vendor can check the payment's `status_code` to see whether it succeeded. _2000 (OK)_ means that the payment is captured and has been transferred to the merchant:

```json
// GET https://api.settle.demo/merchant/v1/payment_request/p2ybyw4tq73n/outcome/

{
  "status": "pending",
  "customer": "token:5632006343884800",
  "attachment_uri": <removed>,
  "pos_tid": "vendors_transaction_id",
  "refunds": [

  ],
  "auth_amount": 0,
  "auth_additional_amount": 0,
  "captures": [

  ],
  "date_modified": "2019-03-21 08:58:49",
  "date_expires": "2019-03-26 08:59:07",
  "credit": false,
  "amount": 2000,
  "interchange_fee": 0,
  "status_code": 1003,
  "tid": "p2ybyw4tq73n",
  "pos_id": "id-of-the-pos",
  "currency": "EUR",
  "additional_amount": 0,
  "transaction_fee": 0,
  "permissions": null
}
```

For a full list of status codes, see the [outcome documentation](https://developer.settle.eu/handlers.html#outcome).
